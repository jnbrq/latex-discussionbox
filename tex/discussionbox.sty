\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{discussionbox}[DiscussionBox package]
\RequirePackage{mdframed}
\RequirePackage{xcolor}
\RequirePackage{pgffor}
\RequirePackage{hyperref}

% discussion environment
\makeatletter

% maximum number of levels supported
\def\discussionbox@maxlevels{128}

% internal counters
\newcounter{discussionbox@id} % current discussion box
\newcounter{discussionbox@level}[discussionbox@id] % current reply level
\newcounter{discussionbox@msg}[discussionbox@id] % current message number

% create counters for levels
\newcounter{discussionbox@lvl0}[discussionbox@id]
\foreach \x in {1,...,\the\numexpr\discussionbox@maxlevels-1\relax} {
    \newcounter{discussionbox@lvl\x}[discussionbox@lvl\the\numexpr\x-1\relax]
}

\newenvironment{discussionbox}[0]{
    \ifx\discussionbox@\undefined
        \def\discussionbox@{}
        \stepcounter{discussionbox@id}
        \begin{mdframed}[
            backgroundcolor=green!10,
            linewidth=1.5pt,
            frametitle={Discussion Box \#\arabic{discussionbox@id}},
            frametitlealignment=\centering,
            frametitlerule=true,
            frametitlerulewidth=1.5pt
        ]
    \else
        \PackageError{discussionbox}{no nesting allowed}{nesting discussion box environments is not allowed}
    \fi
}
{
    \end{mdframed}
    \let\discussionbox@\undefined
}

\newcommand\discussionbox@addr[0]{%
    \ifx\discussionbox@\undefined%
        (none)%
    \else%
        D\arabic{discussionbox@id}%
        \foreach \lvl in {1,...,\value{discussionbox@level}} {%
            .\arabic{discussionbox@lvl\lvl}%
        }%
    \fi%
}

% typesetting for discussion replies (based on the quotation environment)
\newenvironment{discussionbox@reply}
               {\list{}{}\item\relax}
               {\endlist}

% usage: \DefinePerson{name}{color}
\newcommand{\DefinePerson}[2]{
    \expandafter\newcommand\csname #1\endcsname[1]{
        \ifx\discussionbox@\undefined % not in a discussion
            \noindent{\color{#2} {\bf #1} {##1}}
        \else % in a discussion
            \stepcounter{discussionbox@msg}
            \stepcounter{discussionbox@level}
            \stepcounter{discussionbox@lvl\arabic{discussionbox@level}}
            \ifnum\value{discussionbox@level}=1
                    \noindent{\color{#2} {\bf #1} \textsuperscript{[\discussionbox@addr]} {##1}}
            \else
                \begin{discussionbox@reply}
                    \noindent{\color{#2} {\bf #1} \textsuperscript{[\discussionbox@addr]} {##1}}
                \end{discussionbox@reply}
            \fi
            \addtocounter{discussionbox@level}{-1}
        \fi
    }
}

\makeatother
