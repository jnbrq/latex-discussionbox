% Canberk SÃ¶nmez
% DiscussionBox package

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{discussionbox}[DiscussionBox package]
\RequirePackage{mdframed}
\RequirePackage{xcolor}
\RequirePackage{hyperref}
\RequirePackage{pgffor}

\makeatletter

% basic accessors, use them for customization

% id of the current discussion box
\gdef\dbox@id{}

% title of the current discussion box
\gdef\dbox@title{}

% address of the current message
\gdef\dbox@msgaddr{}

% id of the current message
\gdef\dbox@msgid{}

% global id of the current message
\gdef\dbox@msggid{}

% person who wrote the current message
\gdef\dbox@msgperson{}

% color of the person who wrote the current message
\gdef\dbox@msgcolor{}

% depth of the current message
\gdef\dbox@msglevel{}

% id of the next discussion box (for generating the title)
\gdef\dbox@nextid{}

% @-free interface for the commands above
\gdef\dbox#1{\csname dbox@#1\endcsname}

% [customize] default mdframed environment
\newenvironment{dbox@mdframed}{%
    \begin{mdframed}[%
        backgroundcolor=green!4,%
        linewidth=1.5pt,%
        frametitle={\dbox@title},%
        frametitlealignment=\centering,%
        frametitlerule=true,%
        frametitlerulewidth=1.5pt%
    ]%
}{%
    \end{mdframed}%
}

% [customize] default reply environment
\newenvironment{dbox@reply}{%
    \list{}{}\item\relax%
}{%
    \endlist%
}

% [customize] default typesetting for the description line of the message
\newcommand{\dbox@msgdesc}{%
    \color{\dbox@msgcolor} \dbox@msgtarget {\bf \dbox@msgperson} \textsuperscript{[\dbox@msgaddr]}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% used for jumping to messages
\newcommand{\dbox@msgtarget}{\Hy@raisedlink{\hypertarget{tgt@\dbox@msgaddr}{}}}

\global\let\dbox@\undefined

\gdef\dbox@msgperson{%
    \csname dbox@msgpersonlist\dbox@msglevel\endcsname%
}

% setter
\gdef\dbox@msgperson@#1{%
    \expandafter\xdef\csname dbox@msgpersonlist\dbox@msglevel\endcsname{#1}%
}

\gdef\dbox@msgcolor{%
    \csname dbox@msgcolorlist\dbox@msglevel\endcsname%
}

% setter
\gdef\dbox@msgcolor@#1{%
    \expandafter\xdef\csname dbox@msgcolorlist\dbox@msglevel\endcsname{#1}%
}

\gdef\dbox@nextid{\the\numexpr\value{dbox@id} + 1\relax}

% maximum number of levels supported
\gdef\dbox@maxlevels{128}

% internal counters
\newcounter{dbox@id}
\gdef\dbox@id{\arabic{dbox@id}}

\newcounter{dbox@msglevel}[dbox@id]
\gdef\dbox@msglevel{\arabic{dbox@msglevel}}

\newcounter{dbox@msgid}[dbox@id]
\gdef\dbox@msgid{\arabic{dbox@msgid}}

\newcounter{dbox@msggid}
\gdef\dbox@msggid{\arabic{dbox@msggid}}

% create counters for levels
\newcounter{dbox@lvl0}[dbox@id]
\foreach \x in {1,...,\the\numexpr\dbox@maxlevels-1\relax} {
    \newcounter{dbox@lvl\x}[dbox@lvl\the\numexpr\x-1\relax]
}

\newenvironment{discussionbox}[1][Discussion Box \#\dbox@nextid]{%
    \ifx\dbox@\undefined%
        \xdef\dbox@{}%
        \xdef\dbox@title{#1}%
        \stepcounter{dbox@id}%
        \begin{dbox@mdframed}%
    \else%
        \PackageError{discussionbox}{%
            no nesting allowed}{%
            nesting discussion box environments is not allowed}%
    \fi%
}{%
        \end{dbox@mdframed}%
        \global\let\dbox@\undefined%
        \xdef\dbox@title{}%
}

% typesetting for discussion replies (based on the quotation environment)

% usage: \DefinePerson{name}{color}
\newcommand{\DefinePerson}[2]{
    \expandafter\newcommand\csname #1\endcsname[1]{
        \stepcounter{dbox@msggid}
        \ifx\dbox@\undefined % not in a discussion
            \def\dbox@msgaddr{(none)}
            \noindent{\color{#2} {\bf #1} {##1}}
        \else % in a discussion
            \stepcounter{dbox@msgid}
            \stepcounter{dbox@msglevel}
            \stepcounter{dbox@lvl\dbox@msglevel}

            \dbox@msgperson@{#1}
            \dbox@msgcolor@{#2}

            % since DefinePerson is called in the preamble, we should use xdef
            % xdef stands for global expanding definition
            % we must use \foreach independently because it is not expandable.
            % pass/update the global variable
            \xdef\dbox@msgaddr{D\dbox@id}
            \foreach \lvl in {1,...,\dbox@msglevel} {
                \xdef\dbox@msgaddr{\dbox@msgaddr.\arabic{dbox@lvl\lvl}}
            }

            \ifnum\value{dbox@msglevel}=1
            \else
            \begin{dbox@reply}
            \fi
                \noindent{\dbox@msgdesc {##1}}
            \ifnum\value{dbox@msglevel}=1
            \else
            \end{dbox@reply}
            \fi
            \addtocounter{dbox@msglevel}{-1}
        \fi
    }
}

% check out the following links
%  - https://tex.stackexchange.com/questions/111280/understanding-how-references-and-labels-work
%  - https://tex.stackexchange.com/questions/18191/defining-custom-labels
%  - https://tex.stackexchange.com/questions/512148/reference-for-newlabel
%

\def\LabelMsg#1{\@bsphack%
    \begingroup%
    \def\label@name{#1}%
    \label@hook%
    \protected@write\@auxout{}{%
        \string\newlabel{#1}{%
            {\dbox@msgaddr}%
            {\thepage}%
            {\@currentlabelname}%
            {tgt@\dbox@msgaddr}{}%
        }%
    }%
    \endgroup%
\@esphack}

\makeatother
